import{g as p,$ as a,s as k,N as l,d as m,r as b,w as E}from"./main-BARQQjOO.js";import{p as $,d as f,b as v,r as N,s as F,n as M,q as z,t as D,f as L}from"./firebase-JzOrHdc0.js";import"./main-B23-m-1d.js";import"./vendor-B2AETYxa.js";const V=()=>{let o=[],n=p("wiSmile"),C=null;const r=new Audio,e={actual:null,playing:!1,repeat:!1,volume:.7,editando:null};a("#musica").html(`
    <div class='mwb mus_container ${n?.email?"autenticado":"no_auth"}'>
      <div class='mus_lista'>
        <div class='mus_player'>
          <div class='mus_player_info'><span id='musActual'>ðŸŽµ Selecciona una canciÃ³n</span></div>
          <div class='mus_player_ctrls dpc'>
            <button class='mus_ctrl' id='musPrev'><i class='fas fa-backward'></i></button>
            <button class='mus_ctrl mus_play' id='musPlay'><i class='fas fa-play'></i></button>
            <button class='mus_ctrl' id='musNext'><i class='fas fa-forward'></i></button>
            <button class='mus_ctrl' id='musRep'><i class='fas fa-repeat'></i></button>
            ${n?.email?'<button class="mus_ctrl" id="musFav"><i class="fas fa-star"></i></button>':""}
          </div>
          <div class='mus_pgc'>
            <div class='mus_pgb'><div class='mus_pg'></div></div>
            <div class='mus_time dpw'><span id='musCur'>0:00</span><span id='musDur'>0:00</span></div>
          </div>
        </div>
        <div class='mus_plst'>
          <div class='mus_plh dpw'><span class='mus_ttl'>ðŸŽµ Lista de MÃºsica (${o.length})</span><input id='musSrc' placeholder='ðŸ” Buscar...' type='text'/></div>
          <div class='mus_pls' id='musPls'></div>
        </div>
      </div>
      ${n?.email?`<div class='mus_form'>
        <div class='mus_form_hd'><h3><i class='fas fa-music'></i> <span id='formTitle'>Agregar CanciÃ³n</span></h3></div>
        <div class='mus_form_body'>
          <div class='form_grp'><label><i class='fas fa-font'></i> Nombre *</label><input class='mus_inp_nombre' maxlength='100' placeholder='Nombre de la canciÃ³n'></div>
          <div class='form_grp'><label><i class='fas fa-microphone'></i> Cantante *</label><input class='mus_inp_cantante' maxlength='100' placeholder='Artista o intÃ©rprete'></div>
          <div class='form_grp'><label><i class='fas fa-link'></i> URL MP3 *</label><input class='mus_inp_url' placeholder='https://.../cancion.mp3'><small>Enlace directo al archivo .mp3</small></div>
          <div class='form_grp'><label><i class='fas fa-tag'></i> CategorÃ­a</label><select class='mus_inp_tag'><option value='alabanza'>ðŸŽµ Alabanza</option><option value='adoracion'>â›ª AdoraciÃ³n</option><option value='reflexion'>ðŸ§˜ ReflexiÃ³n</option></select></div>
          <div class='form_checks'>
            <div class='form_check'><input type='checkbox' id='musFavorito'><label for='musFavorito'><i class='fas fa-star'></i> Favorita</label></div>
            <div class='form_check'><input type='checkbox' id='musPublico' checked><label for='musPublico'><i class='fas fa-eye'></i> PÃºblica</label></div>
          </div>
          <div class='form_btns dpw'><button class='btn_sec' id='musClear'><i class='fas fa-times'></i> Limpiar</button><button class='btn_pri mus_guardar'><i class='fas fa-save'></i> <span>Guardar</span></button></div>
        </div>
      </div>`:""}
    </div>
  `);const h=s=>isNaN(s)?"0:00":`${~~(s/60)}:${String(~~(s%60)).padStart(2,"0")}`,x=()=>{const s=a("#musPls");if(s.empty(),!o.length)return s.html('<div class="mus_empty"><i class="fas fa-music"></i><p>No hay canciones todavÃ­a</p></div>');o.forEach((i,t)=>{const c=e.actual?.id===i.id,u=n?.email===i.email;s.append(`<div class="mus_pi ${c?"active":""} ${i.favorito?"fav":""}" data-id="${i.id}">
        <span class="mus_n">${t+1}</span>
        <div class="mus_pi_info"><span class="mus_t">${i.nombre}</span><small class="mus_a">${i.cantante}</small></div>
        ${u?`<div class="mus_acts">
          <button class="mus_act mus_act_fav ${i.favorito?"active":""}" data-id="${i.id}" title="Favorito"><i class="fas fa-star"></i></button>
          <button class="mus_act mus_act_edit" data-id="${i.id}" title="Editar"><i class="fas fa-edit"></i></button>
          <button class="mus_act mus_act_del" data-id="${i.id}" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
        </div>`:""}
      </div>`)}),a(".mus_ttl").text(`ðŸŽµ Lista de MÃºsica (${o.length})`)},_=s=>{s&&(e.actual=s,r.src=s.url,a("#musActual").text(`${s.nombre} - ${s.cantante}`),a(".mus_pi").removeClass("active").filter(`[data-id="${s.id}"]`).addClass("active")[0]?.scrollIntoView({behavior:"smooth",block:"center"}),a("#musFav").toggleClass("active",s.favorito),k("musActual",s.id,168))},d=()=>{if(!e.actual){if(!o.length)return l("No hay canciones","warning");_(o[0])}r.play().then(()=>{e.playing=!0,a("#musPlay i").attr("class","fas fa-pause"),l(`ðŸŽµ ${e.actual.nombre}`,"info",2e3)}).catch(()=>l("Error al reproducir","error"))},w=()=>{r.pause(),e.playing=!1,a("#musPlay i").attr("class","fas fa-play")},y=s=>{if(!o.length)return;const i=o.findIndex(c=>c.id===e.actual?.id),t=o[i+s]||o[s>0?0:o.length-1];_(t),d()};a(r).on({timeupdate:()=>{const{currentTime:s,duration:i}=r;isNaN(i)||(a("#musCur").text(h(s)),a("#musDur").text(h(i)),a(".mus_pg").css("width",`${s/i*100}%`))},ended:()=>e.repeat?(r.currentTime=0,d()):y(1),loadedmetadata:()=>a("#musDur").text(h(r.duration))}),a(document).on("click","#musPlay",()=>e.playing?w():d()),a(document).on("click","#musPrev",()=>y(-1)),a(document).on("click","#musNext",()=>y(1)),a(document).on("click","#musRep",function(){e.repeat=!e.repeat,a(this).toggleClass("active"),k("musRep",e.repeat,168)}),a(document).on("click","#musFav",async function(){if(!e.actual||n?.email!==e.actual.email)return l("Sin permisos","warning");const s=!e.actual.favorito;try{a(this).toggleClass("active"),await $(f(m,"wimusica",e.actual.id),{favorito:s,actualizado:v()}),e.actual.favorito=s,b("wiMusica")}catch(i){console.error(i),a(this).toggleClass("active"),l("Error","error")}}),a(document).on("click",".mus_pgb",function(s){r.duration&&(r.currentTime=s.offsetX/a(this).width()*r.duration)}),a(document).on("click",".mus_pi",function(s){if(a(s.target).closest(".mus_acts").length)return;const i=a(this).data("id"),t=o.find(c=>c.id===i);t&&(e.actual?.id===i?e.playing?w():d():(_(t),d()))}),a(document).on("input","#musSrc",function(){const s=a(this).val().toLowerCase();a(".mus_pi").each(function(){a(this).toggle(a(this).text().toLowerCase().includes(s))})});const P=()=>{a(".mus_inp_nombre,.mus_inp_cantante,.mus_inp_url").val(""),a(".mus_inp_tag").val("alabanza"),a("#musFavorito").prop("checked",!1),a("#musPublico").prop("checked",!0),e.editando=null,a("#formTitle").text("Agregar CanciÃ³n"),a(".mus_guardar span").text("Guardar"),a(".mus_guardar i").attr("class","fas fa-save")};a(document).on("click","#musClear",P),a(document).on("click",".mus_act_fav",async function(s){s.stopPropagation();const i=a(this).data("id"),t=o.find(u=>u.id===i);if(!t||n?.email!==t.email)return l("Sin permisos","warning");const c=!t.favorito;try{a(this).toggleClass("active"),a(this).closest(".mus_pi").toggleClass("fav"),await $(f(m,"wimusica",i),{favorito:c,actualizado:v()}),t.favorito=c,b("wiMusica")}catch(u){console.error(u),a(this).toggleClass("active"),a(this).closest(".mus_pi").toggleClass("fav"),l("Error","error")}}),a(document).on("click",".mus_act_edit",function(s){s.stopPropagation();const i=o.find(t=>t.id===a(this).data("id"));if(!i||n?.email!==i.email)return l("Sin permisos","warning");e.editando=i.id,a(".mus_inp_nombre").val(i.nombre),a(".mus_inp_cantante").val(i.cantante),a(".mus_inp_url").val(i.url),a(".mus_inp_tag").val(i.tag||"alabanza"),a("#musFavorito").prop("checked",i.favorito),a("#musPublico").prop("checked",i.publico!==!1),a("#formTitle").text("Editar CanciÃ³n"),a(".mus_guardar span").text("Actualizar"),a(".mus_guardar i").attr("class","fas fa-edit"),a(".mus_inp_nombre").focus(),a(".mus_form")[0]?.scrollIntoView({behavior:"smooth",block:"start"})}),a(document).on("click",".mus_act_del",async function(s){s.stopPropagation();const i=a(this).data("id"),t=o.find(c=>c.id===i);if(!t||n?.email!==t.email)return l("Sin permisos","warning");if(confirm(`Â¿Eliminar "${t.nombre}"?`))try{await N(f(m,"wimusica",i)),a(this).closest(".mus_pi").fadeOut(300,function(){a(this).remove()}),e.actual?.id===i&&(w(),e.actual=null,a("#musActual").text("ðŸŽµ Selecciona una canciÃ³n")),b("wiMusica"),l("ðŸ—‘ï¸ Eliminada","success")}catch(c){console.error(c),l("Error","error")}}),a(document).on("click",".mus_guardar",async function(){const s=a(".mus_inp_nombre").val().trim(),i=a(".mus_inp_cantante").val().trim(),t=a(".mus_inp_url").val().trim(),c=a(".mus_inp_tag").val(),u=a("#musFavorito").is(":checked"),S=a("#musPublico").is(":checked");if(!s||!i||!t)return l("Completa todos los campos","warning");if(!t.toLowerCase().includes(".mp3"))return l("Debe ser .mp3","warning");try{E(this,!0);const g={nombre:s,cantante:i,url:t,tag:c,favorito:u,publico:S,usuario:n.usuario||n.email.split("@")[0],email:n.email};e.editando?(await $(f(m,"wimusica",e.editando),{...g,actualizado:v()}),l("âœ… Actualizada","success")):(await F(f(m,"wimusica",`musica_${Date.now()}`),{...g,creado:v(),actualizado:v()}),l("âœ… Agregada","success")),b("wiMusica"),P()}catch(g){console.error(g),l("Error","error")}finally{E(this,!1)}});const A=p("wiMusica");return A&&(o=A,x(),((s=p("musActual"))=>{const i=o.find(t=>t.id===s);i&&_(i)})(),((s=p("musVol"))=>s!==null&&(r.volume=e.volume=s))(),p("musRep")&&(e.repeat=!0,a("#musRep").addClass("active"))),C=M(z(L(m,"wimusica"),D("creado","desc")),s=>{const i=s.docs.map(t=>({id:t.id,...t.data()}));o=n?.email?[...i.filter(t=>t.email===n.email),...i.filter(t=>t.email!==n.email&&t.publico!==!1)].sort((t,c)=>c.favorito-t.favorito||(c.creado?.seconds||0)-(t.creado?.seconds||0)):i.filter(t=>t.publico!==!1).sort((t,c)=>c.favorito-t.favorito||(c.creado?.seconds||0)-(t.creado?.seconds||0)),k("wiMusica",o,168),x()},()=>l("Desde cachÃ©","info",2e3)),window.addEventListener("wiFresh",s=>{n=s.detail,location.reload()}),()=>{C?.(),r.pause(),r.src="",a(document).off("click"),console.log("ðŸŽµ MÃºsica limpiado")}};export{V as musica};
